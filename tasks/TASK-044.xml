<?xml version="1.0" encoding="UTF-8"?>
<task>
    <task-id>TASK-044</task-id>
    <task-name>Fix Flaky Integration Tests in PdfGenerationIT</task-name>
    <phase>Maintenance: Spring Boot 3.4 Migration</phase>
    <priority>MEDIUM</priority>
    <complexity>MODERATE</complexity>
    <status>Completed</status>

    <dependencies>
        <dependency>Spring Boot 3.4.5 migration completed</dependency>
        <dependency>TASK-021: Integration tests infrastructure</dependency>
    </dependencies>

    <description>
        Fix flaky integration tests in PdfGenerationIT that fail intermittently when running
        the full test suite but pass when run in isolation. The failures occur specifically in:
        - testMultiplePdfsFromSameGenerator
        - testPageRanges_multiPageDocument

        Both tests fail with "ChromeDevToolsInvocationException: Printing failed" on the second
        or third PDF generation within a single test method, indicating Chrome/CDP session
        instability after repeated use under load.

        Root causes identified:
        1. Resource contention - Multiple Chrome processes running simultaneously
        2. Timing issues - Chrome/CDP not fully ready between rapid successive operations
        3. Test isolation issues - Previous tests may leave Chrome in unstable state
    </description>

    <acceptance-criteria>
        <criterion>Full test suite passes consistently without flaky failures</criterion>
        <criterion>Tests still pass when run in isolation</criterion>
        <criterion>No test stability regressions introduced</criterion>
        <criterion>Solution doesn't significantly increase test execution time</criterion>
        <criterion>Chrome processes are properly cleaned up between tests</criterion>
    </acceptance-criteria>

    <implementation-notes>
        <note>
            Option 1: Add small delays between PDF generations
            - Add Thread.sleep(100-500ms) between successive generate() calls in tests
            - Pros: Simple, minimal code changes
            - Cons: Increases test execution time slightly
            - Implementation: Add delays in testMultiplePdfsFromSameGenerator after each generate()
        </note>
        <note>
            Option 2: Increase Chrome operation timeouts
            - Increase default timeout in ChromeOptions from 30s to 60s
            - Increase page load timeout in PdfGenerator
            - Pros: More tolerant of slow systems
            - Cons: May mask real performance issues
            - Implementation: Modify ChromeOptions.DEFAULT_TIMEOUT and PdfGenerator timeouts
        </note>
        <note>
            Option 3: Close and reopen PdfGenerator between multiple generations
            - In tests that generate multiple PDFs, close and recreate PdfGenerator instance
            - Pros: Ensures fresh Chrome state for each PDF
            - Cons: Slower tests, more resource churn
            - Implementation: Modify testMultiplePdfsFromSameGenerator to use try-with-resources
              per PDF generation instead of reusing single instance
        </note>
        <note>
            Option 4: Reduce test parallelism
            - Configure maven-failsafe-plugin with forkCount=1 and reuseForks=true
            - Pros: Eliminates resource contention
            - Cons: Significantly slower test execution
            - Implementation: Add configuration to pom.xml failsafe plugin
        </note>
        <note>
            Recommended approach: Combination of Options 1 and 2
            1. Add 200ms delay between PDF generations in multi-PDF tests
            2. Increase page load timeout from 30s to 45s
            3. Ensure proper cleanup in @AfterEach methods

            This provides stability without excessive performance impact.
        </note>
    </implementation-notes>

    <affected-files>
        <file>pdf-via-chrome/src/test/java/com/fostermoore/pdfviachrome/PdfGenerationIT.java</file>
        <file>pdf-via-chrome/src/main/java/com/fostermoore/pdfviachrome/chrome/ChromeOptions.java (optional)</file>
        <file>pdf-via-chrome/pom.xml (optional - for parallelism configuration)</file>
    </affected-files>

    <testing-requirements>
        <requirement>Run full integration test suite 5 times consecutively - all must pass</requirement>
        <requirement>Run failing tests in isolation - must still pass</requirement>
        <requirement>Verify no Chrome zombie processes remain after test execution</requirement>
        <requirement>Total test execution time should not increase by more than 10%</requirement>
        <requirement>All 12 tests in PdfGenerationIT must pass</requirement>
    </testing-requirements>

    <implementation-steps>
        <step>
            Step 1: Add delays in testMultiplePdfsFromSameGenerator
            - Add Thread.sleep(200) between pdf1, pdf2, and pdf3 generation
            - Add try-catch for InterruptedException
        </step>
        <step>
            Step 2: Add delays in testPageRanges_multiPageDocument
            - Add Thread.sleep(200) between allPagesPdf, rangePdf, specificPagesPdf, mixedRangesPdf
            - Add try-catch for InterruptedException
        </step>
        <step>
            Step 3: (Optional) Increase timeouts in ChromeOptions
            - Change DEFAULT_TIMEOUT from Duration.ofSeconds(30) to Duration.ofSeconds(45)
            - Document reason for change in comments
        </step>
        <step>
            Step 4: Enhanced cleanup in @AfterEach
            - Ensure pdfGenerator.close() is called even if test fails
            - Add verification that Chrome process is terminated
        </step>
        <step>
            Step 5: Test the fix
            - Run mvn clean verify multiple times
            - Monitor for any remaining flaky failures
            - Adjust delays if needed
        </step>
    </implementation-steps>

    <code-example>
        <example-description>Example fix for testMultiplePdfsFromSameGenerator</example-description>
        <example-code>
@Test
void testMultiplePdfsFromSameGenerator() throws IOException {
    // Given
    String html1 = "&lt;html&gt;&lt;body&gt;&lt;h1&gt;First Document&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;";
    String html2 = "&lt;html&gt;&lt;body&gt;&lt;h1&gt;Second Document&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;";
    String html3 = "&lt;html&gt;&lt;body&gt;&lt;h1&gt;Third Document&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;";

    // When - Generate multiple PDFs from the same generator instance
    byte[] pdf1 = pdfGenerator.fromHtml(html1).generate();

    // Add delay to allow Chrome to fully reset between generations
    Thread.sleep(200);

    byte[] pdf2 = pdfGenerator.fromHtml(html2).generate();

    Thread.sleep(200);

    byte[] pdf3 = pdfGenerator.fromHtml(html3).generate();

    // Then - All PDFs should be valid and contain correct content
    assertValidPdf(pdf1);
    assertPdfContainsText(pdf1, "First Document");

    assertValidPdf(pdf2);
    assertPdfContainsText(pdf2, "Second Document");

    assertValidPdf(pdf3);
    assertPdfContainsText(pdf3, "Third Document");
}
        </example-code>
    </code-example>

    <verification-commands>
        <command>mvn clean verify -pl pdf-via-chrome</command>
        <command>mvn verify -Dit.test=PdfGenerationIT -pl pdf-via-chrome</command>
        <command>mvn verify -Dit.test=PdfGenerationIT#testMultiplePdfsFromSameGenerator -pl pdf-via-chrome</command>
        <command>mvn verify -Dit.test=PdfGenerationIT#testPageRanges_multiPageDocument -pl pdf-via-chrome</command>
    </verification-commands>

    <estimated-effort>2-3 hours</estimated-effort>
    <actual-effort>Approximately 1 hour</actual-effort>
    <completion-date>2025-12-31</completion-date>

    <notes>
        <note>
            These flaky tests were discovered during Spring Boot 3.4 migration testing.
            When tests are run individually, they pass 100% of the time, indicating the
            issue is related to test suite execution order and resource management.
        </note>
        <note>
            Alternative workaround: Run build with -DskipTests for production builds,
            but this should only be temporary until the flakiness is resolved.
        </note>
        <note>
            Future enhancement: Consider implementing a Chrome process pool to reuse
            Chrome instances across tests, which could improve both stability and performance.
        </note>
        <note>
            Date: 2025-12-31
            Additional flaky test discovered: CssInjectionTest.testCssInjectionWithMultipleCalls

            Symptom: Test fails intermittently with "Failed to inject CSS: Uncaught" error
            when running full test suite (mvn test), but passes when run individually or
            when running just the CssInjectionTest class.

            Error details:
            - PdfGenerationException: Failed to inject CSS: Uncaught
            - Occurs at PdfGenerator$GenerationBuilder.injectCss(PdfGenerator.java:677)
            - JavaScript execution in CSS injection fails with generic "Uncaught" error

            Root cause analysis:
            - The test calls withCustomCss() twice, expecting second call to override first
            - Under load or timing pressure, the JavaScript that injects CSS fails to execute
            - Suggests Chrome/CDP not fully ready when CSS injection is attempted
            - Similar resource contention/timing issues as PdfGenerationIT failures

            Impact:
            - Low severity - test passes on retry and in isolation
            - Indicates potential fragility in CSS injection implementation under load

            Recommended investigation:
            1. Add synchronization/wait before CSS injection to ensure page is ready
            2. Add retry logic for CSS injection JavaScript execution failures
            3. Improve error messages to provide more context than generic "Uncaught"
            4. Consider adding explicit readiness check before executing injection JavaScript

            Files affected:
            - pdf-via-chrome/src/test/java/com/fostermoore/pdfviachrome/CssInjectionTest.java
            - pdf-via-chrome/src/main/java/com/fostermoore/pdfviachrome/api/PdfGenerator.java
              (specifically the injectCss() method around line 643-687)
        </note>
    </notes>
</task>
