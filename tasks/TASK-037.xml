<?xml version="1.0" encoding="UTF-8"?>
<task>
    <task-id>TASK-037</task-id>
    <task-name>Add Error Handling and Logging</task-name>
    <phase>Phase 6: Test Application</phase>
    <priority>MEDIUM</priority>
    <complexity>SIMPLE</complexity>
    <status>COMPLETED</status>
    <completion-date>2025-12-17</completion-date>

    <dependencies>
        <dependency>TASK-034: Implement REST Endpoints</dependency>
        <dependency>TASK-036: Add Request Validation</dependency>
    </dependencies>

    <description>
        Implement comprehensive error handling and logging throughout the test
        application to aid in debugging and provide good user experience.
    </description>

    <acceptance-criteria>
        <criterion>Logging configured with SLF4J and Logback</criterion>
        <criterion>Request/response logging for API endpoints</criterion>
        <criterion>Error logging with stack traces</criterion>
        <criterion>Performance logging (PDF generation time)</criterion>
        <criterion>Different log levels for different environments</criterion>
        <criterion>Log files rotated and managed</criterion>
    </acceptance-criteria>

    <implementation-notes>
        <note>
            Configure Logback in logback-spring.xml:
            - Console appender for development
            - File appender for production
            - Different log levels per package
        </note>
        <note>
            Add logging in controller:
            - Request received (INFO)
            - PDF generation started (DEBUG)
            - PDF generation completed with duration (INFO)
            - Errors with full stack trace (ERROR)
        </note>
        <note>
            Add LoggingInterceptor for request/response logging
        </note>
        <note>
            Log Chrome process lifecycle events
        </note>
        <note>
            Consider adding correlation IDs for request tracing
        </note>
    </implementation-notes>

    <affected-files>
        <file>headless-chrome-pdf-test-app/src/main/resources/logback-spring.xml</file>
        <file>headless-chrome-pdf-test-app/src/main/java/com/github/headlesschromepdf/testapp/config/LoggingConfig.java</file>
        <file>headless-chrome-pdf-test-app/src/main/java/com/github/headlesschromepdf/testapp/controller/PdfController.java</file>
    </affected-files>

    <testing-requirements>
        <requirement>Verify logs are written to console</requirement>
        <requirement>Verify logs are written to file</requirement>
        <requirement>Test different log levels</requirement>
        <requirement>Verify error logging includes stack traces</requirement>
        <requirement>Manual testing of various scenarios</requirement>
    </testing-requirements>

    <estimated-effort>2-3 hours</estimated-effort>

    <implementation-summary>
        <summary>
            Comprehensive error handling and logging has been implemented throughout the
            test application with logback configuration, performance metrics, and detailed
            request/response logging.
        </summary>
        <completed-features>
            <feature>logback-spring.xml configuration with console, file, error, and performance appenders</feature>
            <feature>Rolling file appenders with size and time-based rotation (10MB per file, 30-90 days retention)</feature>
            <feature>Separate log files for general logs, errors, and performance metrics</feature>
            <feature>Spring profile-based logging (dev, prod, test profiles)</feature>
            <feature>Enhanced PdfController with performance logging (tracks PDF generation duration)</feature>
            <feature>Structured performance logs in CSV format for analysis</feature>
            <feature>Try-catch error handling in controller with duration tracking on failures</feature>
            <feature>Request and response logging with DEBUG level for detailed troubleshooting</feature>
            <feature>Configured logging levels per package (DEBUG for app, WARN for CDP library)</feature>
            <feature>application.properties enhanced with logging configuration and file paths</feature>
        </completed-features>
        <files-created>
            <file>headless-chrome-pdf-test-app/src/main/resources/logback-spring.xml</file>
        </files-created>
        <files-modified>
            <file>headless-chrome-pdf-test-app/src/main/resources/application.properties</file>
            <file>headless-chrome-pdf-test-app/src/main/java/com/github/headlesschromepdf/testapp/controller/PdfController.java</file>
        </files-modified>
        <logging-appenders>
            <appender name="CONSOLE">Console output for development</appender>
            <appender name="FILE">Rolling file appender for general logs (10MB, 30 days)</appender>
            <appender name="ERROR_FILE">Rolling file appender for ERROR level only (10MB, 90 days)</appender>
            <appender name="PERFORMANCE_FILE">Performance metrics in structured CSV format (10MB, 30 days)</appender>
        </logging-appenders>
        <log-files>
            <file>logs/headless-chrome-pdf-app.log - Main application log</file>
            <file>logs/headless-chrome-pdf-errors.log - Error-only log</file>
            <file>logs/headless-chrome-pdf-performance.log - Performance metrics (CSV format)</file>
        </log-files>
        <test-results>
            <result>All 39 tests passing (26 validation + 13 controller tests)</result>
            <result>Logging verified in test output - shows DEBUG, INFO, WARN, ERROR levels</result>
            <result>Performance logs verified - CSV format with html_length, pdf_size, duration_ms</result>
        </test-results>
    </implementation-summary>
</task>
