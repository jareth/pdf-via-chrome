<?xml version="1.0" encoding="UTF-8"?>
<task>
    <task-id>TASK-029</task-id>
    <task-name>Implement JavaScript Execution</task-name>
    <phase>Phase 5: Advanced Features</phase>
    <priority>MEDIUM</priority>
    <complexity>MODERATE</complexity>
    <status>Completed</status>

    <dependencies>
        <dependency>TASK-018: Create HTML-to-PDF Converter</dependency>
    </dependencies>

    <description>
        Add capability to execute custom JavaScript before PDF generation.
        This allows users to manipulate the page, trigger actions, or wait for
        dynamic content before capturing the PDF. Works with HTML-to-PDF in Version 1.
        Support for URL sources will be added in Version 2 (Phase 8).
    </description>

    <acceptance-criteria>
        <criterion>PdfGenerator API supports JavaScript execution</criterion>
        <criterion>Can execute JavaScript string</criterion>
        <criterion>Can execute JavaScript from file</criterion>
        <criterion>JavaScript executed after page load, before PDF generation</criterion>
        <criterion>Can access return values from JavaScript</criterion>
        <criterion>Works with HTML-to-PDF conversion</criterion>
        <criterion>Integration tests validate JavaScript execution</criterion>
    </acceptance-criteria>

    <implementation-notes>
        <note>
            Add method to PdfGenerator builder:
            .executeJavaScript(String jsCode)
            .executeJavaScriptFromFile(Path jsFile)
        </note>
        <note>
            Use CDP Runtime.evaluate() to execute JavaScript
        </note>
        <note>
            Execute after page load (or wait strategy), before PDF generation
        </note>
        <note>
            Handle JavaScript errors and log warnings
        </note>
        <note>
            Consider supporting Promise-based JavaScript (await completion)
        </note>
        <note>
            Example use cases:
            - Remove elements: document.querySelector('.ads').remove()
            - Trigger rendering: window.renderChart()
            - Modify content: document.title = 'PDF Export'
        </note>
    </implementation-notes>

    <affected-files>
        <file>pdf-via-chrome/src/main/java/com/fostermoore/pdfviachrome/api/PdfGenerator.java</file>
        <file>pdf-via-chrome/src/main/java/com/fostermoore/pdfviachrome/converter/HtmlToPdfConverter.java</file>
        <file>pdf-via-chrome/src/test/java/com/fostermoore/pdfviachrome/JavaScriptExecutionTest.java</file>
    </affected-files>
    <note>UrlToPdfConverter.java integration will be added in Version 2 (Phase 8, TASK-044)</note>

    <testing-requirements>
        <requirement>Unit test JavaScript execution logic</requirement>
        <requirement>Integration test modifying DOM before PDF generation</requirement>
        <requirement>Integration test with JavaScript from file</requirement>
        <requirement>Test JavaScript error handling</requirement>
        <requirement>Verify JavaScript effects are visible in PDF</requirement>
    </testing-requirements>

    <estimated-effort>5-6 hours</estimated-effort>

    <completion-status>
        <completion-date>2025-12-31</completion-date>
        <summary>
            JavaScript execution capability fully implemented in PdfGenerator API. Users can execute
            custom JavaScript from strings or files to manipulate pages before PDF generation.
            Supports both synchronous and asynchronous (Promise-based) JavaScript.
        </summary>
        <deliverables>
            <deliverable>PdfGenerator.executeJavaScript(String jsCode) - Execute JavaScript from string</deliverable>
            <deliverable>PdfGenerator.executeJavaScriptFromFile(Path jsFile) - Execute JavaScript from file</deliverable>
            <deliverable>Uses CDP Runtime.evaluate() with awaitPromise support for async JS</deliverable>
            <deliverable>JavaScript executed after page load and CSS injection, before PDF generation</deliverable>
            <deliverable>JavaScriptExecutionTest.java - Comprehensive unit tests</deliverable>
            <deliverable>Integration tests in AdvancedFeaturesIT.java</deliverable>
            <deliverable>Error handling for JavaScript execution failures</deliverable>
            <deliverable>Usage examples in README.md and CLAUDE.md</deliverable>
        </deliverables>
    </completion-status>
</task>
