<?xml version="1.0" encoding="UTF-8"?>
<task>
    <task-id>TASK-034</task-id>
    <task-name>Implement REST Endpoints (HTML-to-PDF)</task-name>
    <status>COMPLETED</status>
    <phase>Phase 6: Test Application</phase>
    <priority>MEDIUM</priority>
    <complexity>MODERATE</complexity>

    <dependencies>
        <dependency>TASK-033: Create Spring Boot Application Structure</dependency>
    </dependencies>

    <description>
        Implement REST API endpoint for HTML-to-PDF generation. This endpoint allows
        testing the library via HTTP requests and serves as an API example.
        URL-to-PDF endpoint will be added in Version 2 (Phase 8).
    </description>

    <acceptance-criteria>
        <criterion>POST /api/pdf/from-html endpoint accepts HTML and generates PDF</criterion>
        <criterion>Endpoint accepts PdfOptions as JSON</criterion>
        <criterion>Endpoint returns PDF file with correct Content-Type</criterion>
        <criterion>Error handling returns appropriate HTTP status codes</criterion>
        <criterion>Request validation implemented</criterion>
    </acceptance-criteria>
    <note>POST /api/pdf/from-url endpoint moved to Version 2 (Phase 8, TASK-045)</note>

    <implementation-notes>
        <note>
            Create PdfController with endpoint:

            @PostMapping("/api/pdf/from-html")
            public ResponseEntity&lt;byte[]&gt; generateFromHtml(@RequestBody HtmlRequest request)
        </note>
        <note>
            HtmlRequest DTO should include:
            - content (HTML string)
            - options (PdfOptions as JSON)
            - waitStrategy (optional)
        </note>
        <note>
            Response headers:
            - Content-Type: application/pdf
            - Content-Disposition: attachment; filename="generated.pdf"
        </note>
        <note>
            Use @Valid and @NotBlank for validation
        </note>
        <note>
            Inject PdfGenerator as @Bean (singleton or prototype)
        </note>
    </implementation-notes>

    <affected-files>
        <file>pdf-via-chrome-test-app/src/main/java/com/fostermoore/pdfviachrome/testapp/controller/PdfController.java</file>
        <file>pdf-via-chrome-test-app/src/main/java/com/fostermoore/pdfviachrome/testapp/dto/HtmlRequest.java</file>
        <file>pdf-via-chrome-test-app/src/test/java/com/fostermoore/pdfviachrome/testapp/controller/PdfControllerTest.java</file>
    </affected-files>
    <note>UrlRequest.java moved to Version 2 (Phase 8, TASK-045)</note>

    <testing-requirements>
        <requirement>Unit tests for controller with mocked PdfGenerator</requirement>
        <requirement>Integration test with actual PDF generation</requirement>
        <requirement>Test validation errors return 400 status</requirement>
        <requirement>Test successful PDF generation returns 200 status</requirement>
        <requirement>Manual test with curl or Postman</requirement>
    </testing-requirements>

    <estimated-effort>5-6 hours</estimated-effort>

    <implementation-summary>
        <completed-items>
            <item>Created HtmlRequest DTO with validation (@NotBlank on content field)</item>
            <item>Created PdfOptionsDto with full mapping to PdfOptions (all fields supported)</item>
            <item>Configured PdfGenerator as singleton Spring Bean with destroyMethod</item>
            <item>Implemented PdfController with POST /api/pdf/from-html endpoint</item>
            <item>Created GlobalExceptionHandler with specific handlers for all exception types:
                - MethodArgumentNotValidException (400)
                - IllegalArgumentException (400)
                - ChromeNotFoundException (503)
                - BrowserTimeoutException (504)
                - PageLoadException (422)
                - CdpConnectionException (503)
                - PdfGenerationException (500)
                - Generic Exception (500)
            </item>
            <item>Added spring-boot-starter-validation dependency</item>
            <item>Added spring-boot-starter-test dependency</item>
            <item>Created comprehensive unit tests (8 tests, all passing):
                - Successful PDF generation
                - PDF generation with custom options
                - Validation error for empty content
                - Validation error for null content
                - Invalid paper format error
                - Chrome not found exception
                - Browser timeout exception
                - PDF generation exception
            </item>
            <item>Created integration tests (5 tests):
                - Actual PDF generation with default options
                - PDF generation with custom options
                - Complex HTML with CSS styling
                - Validation error handling
                - Invalid scale handling
            </item>
            <item>Created MANUAL_TESTING.md with curl and PowerShell examples</item>
        </completed-items>
        <files-created>
            <file>pdf-via-chrome-test-app/src/main/java/com/fostermoore/pdfviachrome/testapp/dto/HtmlRequest.java</file>
            <file>pdf-via-chrome-test-app/src/main/java/com/fostermoore/pdfviachrome/testapp/dto/PdfOptionsDto.java</file>
            <file>pdf-via-chrome-test-app/src/main/java/com/fostermoore/pdfviachrome/testapp/config/PdfGeneratorConfig.java</file>
            <file>pdf-via-chrome-test-app/src/main/java/com/fostermoore/pdfviachrome/testapp/controller/PdfController.java</file>
            <file>pdf-via-chrome-test-app/src/main/java/com/fostermoore/pdfviachrome/testapp/controller/GlobalExceptionHandler.java</file>
            <file>pdf-via-chrome-test-app/src/test/java/com/fostermoore/pdfviachrome/testapp/controller/PdfControllerTest.java</file>
            <file>pdf-via-chrome-test-app/src/test/java/com/fostermoore/pdfviachrome/testapp/controller/PdfControllerIntegrationTest.java</file>
            <file>pdf-via-chrome-test-app/src/test/resources/application-test.properties</file>
            <file>pdf-via-chrome-test-app/MANUAL_TESTING.md</file>
        </files-created>
        <files-modified>
            <file>pdf-via-chrome-test-app/pom.xml (added validation and test dependencies, configured surefire plugin)</file>
        </files-modified>
    </implementation-summary>
</task>
