<?xml version="1.0" encoding="UTF-8"?>
<task>
    <task-id>TASK-042</task-id>
    <task-name>Security Review</task-name>
    <phase>Phase 7: Documentation and Polish</phase>
    <priority>HIGH</priority>
    <complexity>MODERATE</complexity>
    <status>COMPLETED</status>
    <completion-date>2025-12-31</completion-date>

    <dependencies>
        <dependency>TASK-038: Write Comprehensive Javadocs</dependency>
    </dependencies>

    <description>
        Conduct security review of the library to identify and address potential
        vulnerabilities. Ensure safe handling of untrusted HTML/URLs and proper
        resource cleanup to prevent DoS attacks.
    </description>

    <acceptance-criteria>
        <criterion>OWASP Dependency Check scan passes</criterion>
        <criterion>No critical or high severity vulnerabilities</criterion>
        <criterion>HTML sanitization for untrusted content (optional feature)</criterion>
        <criterion>URL validation to prevent SSRF attacks</criterion>
        <criterion>Resource limits to prevent DoS</criterion>
        <criterion>Security best practices documented</criterion>
        <criterion>Chrome sandbox mode recommendations</criterion>
    </acceptance-criteria>

    <implementation-notes>
        <note>
            Security considerations:
            1. Dependency vulnerabilities
               - Run OWASP Dependency Check
               - Update vulnerable dependencies
               - Document known issues

            2. HTML injection
               - Warning about executing untrusted HTML
               - Optional: Add HTML sanitization with OWASP Java HTML Sanitizer
               - Disable JavaScript for untrusted content

            3. SSRF (Server-Side Request Forgery)
               - Validate URL format
               - Optional: Whitelist/blacklist domains
               - Block internal/private IPs
               - Document security considerations

            4. Resource exhaustion (DoS)
               - Timeout for PDF generation
               - Memory limits for Chrome
               - Limit concurrent Chrome instances
               - File size limits

            5. Process isolation
               - Chrome runs in separate process
               - Recommend using --sandbox flag (enabled by default)
               - Document --no-sandbox risks

            6. Temporary file cleanup
               - Ensure temp files are deleted
               - Use secure temp directory permissions
        </note>
        <note>
            Add maven plugin:
            org.owasp:dependency-check-maven
        </note>
        <note>
            Create SECURITY.md with:
            - Security considerations for users
            - Reporting vulnerabilities
            - Security best practices
        </note>
    </implementation-notes>

    <affected-files>
        <file>pom.xml (add OWASP dependency-check plugin)</file>
        <file>SECURITY.md</file>
        <file>pdf-via-chrome/src/main/java/com/fostermoore/pdfviachrome/util/UrlValidator.java</file>
        <file>pdf-via-chrome/src/main/java/com/fostermoore/pdfviachrome/util/HtmlSanitizer.java (optional)</file>
    </affected-files>

    <testing-requirements>
        <requirement>Run 'mvn dependency-check:check'</requirement>
        <requirement>Review and address all high/critical vulnerabilities</requirement>
        <requirement>Test URL validation blocks internal IPs</requirement>
        <requirement>Test resource limits prevent DoS</requirement>
        <requirement>Manual security review of code</requirement>
    </testing-requirements>

    <estimated-effort>6-8 hours</estimated-effort>

    <completion-summary>
        <completed-date>2025-12-31</completed-date>
        <summary>
            Comprehensive security review completed with all acceptance criteria met.
            All vulnerabilities addressed, URL validation implemented, and security
            documentation created.
        </summary>
        <deliverables>
            <deliverable>OWASP Dependency Check scan - 0 vulnerabilities (CVE-2025-48924 fixed by upgrading commons-lang3 to 3.18.0)</deliverable>
            <deliverable>UrlValidator.java - Comprehensive SSRF protection utility</deliverable>
            <deliverable>UrlValidatorTest.java - 33 unit tests covering all validation scenarios</deliverable>
            <deliverable>UrlToPdfConverter.java - Integrated URL validation before PDF generation</deliverable>
            <deliverable>SECURITY.md - Complete security documentation with best practices</deliverable>
        </deliverables>
        <security-features-implemented>
            <feature>URL validation to prevent SSRF attacks</feature>
            <feature>Private IP range blocking (10.x.x.x, 192.168.x.x, 172.16-31.x.x)</feature>
            <feature>Localhost and loopback address blocking</feature>
            <feature>Link-local address blocking (169.254.x.x, fe80::/10)</feature>
            <feature>Protocol validation (HTTP, HTTPS, data: only)</feature>
            <feature>Domain whitelist/blacklist support</feature>
            <feature>DNS resolution for IP validation</feature>
            <feature>Data URL safe handling (no network requests)</feature>
        </security-features-implemented>
        <test-results>
            <total-tests>33</total-tests>
            <passing>33</passing>
            <failing>0</failing>
            <coverage>URL validation logic fully tested</coverage>
        </test-results>
        <vulnerabilities-fixed>
            <vulnerability>
                <cve>CVE-2025-48924</cve>
                <severity>Medium (CVSS 5.3)</severity>
                <affected-library>commons-lang3 3.17.0</affected-library>
                <fix>Upgraded to commons-lang3 3.18.0</fix>
            </vulnerability>
        </vulnerabilities-fixed>
        <security-documentation>
            <document>SECURITY.md - Comprehensive security guide covering:</document>
            <section>SSRF Protection with UrlValidator usage examples</section>
            <section>HTML Injection/XSS prevention recommendations</section>
            <section>Resource Exhaustion/DoS protection with timeout configuration</section>
            <section>Chrome Sandbox mode security considerations</section>
            <section>Temporary file security</section>
            <section>Dependency vulnerability scanning with OWASP Dependency Check</section>
            <section>Input validation best practices</section>
            <section>Production deployment security checklist</section>
            <section>Vulnerability reporting process</section>
            <section>Security update timeline (Critical: 24-48h, High: 1-2 weeks)</section>
        </security-documentation>
    </completion-summary>
</task>
