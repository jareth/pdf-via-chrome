<?xml version="1.0" encoding="UTF-8"?>
<task>
    <task-id>TASK-008</task-id>
    <task-name>Implement CdpSession with AutoCloseable</task-name>
    <phase>Phase 2: Core Infrastructure and Design Patterns</phase>
    <priority>HIGH</priority>
    <complexity>COMPLEX</complexity>
    <status>Completed</status>

    <dependencies>
        <dependency>TASK-007: Create ChromeManager with AutoCloseable</dependency>
    </dependencies>

    <description>
        Create CdpSession class that wraps CDP client connections and implements
        AutoCloseable for proper resource cleanup (Design Suggestion #2). This class
        manages the WebSocket connection to Chrome's DevTools Protocol.
    </description>

    <acceptance-criteria>
        <criterion>CdpSession class implements AutoCloseable</criterion>
        <criterion>Establishes WebSocket connection to Chrome using CDP endpoint URL</criterion>
        <criterion>Provides access to CDP domains (Page, Runtime, Network, etc.)</criterion>
        <criterion>close() method closes WebSocket connection</criterion>
        <criterion>Handles connection failures with appropriate exceptions</criterion>
        <criterion>Thread-safe for concurrent access</criterion>
        <criterion>Integration tests validate connection lifecycle</criterion>
    </acceptance-criteria>

    <implementation-notes>
        <note>
            Use chrome-devtools-java-client library (com.github.kklisura.cdt:cdt-java-client)
        </note>
        <note>
            Key CDP service to initialize:
            - ChromeService (factory for CDP connections)
            - ChromeDevToolsService (main service)
            - Page domain (for navigation and PDF generation)
            - Runtime domain (for JavaScript execution)
            - Network domain (for network monitoring)
        </note>
        <note>
            Store ChromeDevToolsService instance
        </note>
        <note>
            close() should close ChromeDevToolsService and underlying WebSocket
        </note>
        <note>
            Consider connection timeout configuration
        </note>
        <note>
            Log CDP protocol events for debugging (using SLF4J)
        </note>
    </implementation-notes>

    <affected-files>
        <file>headless-chrome-pdf-core/src/main/java/com/github/headlesschromepdf/cdp/CdpSession.java</file>
        <file>headless-chrome-pdf-core/src/main/java/com/github/headlesschromepdf/cdp/CdpClient.java</file>
        <file>headless-chrome-pdf-core/src/test/java/com/github/headlesschromepdf/cdp/CdpSessionTest.java</file>
    </affected-files>

    <testing-requirements>
        <requirement>Unit tests with mocked ChromeDevToolsService</requirement>
        <requirement>Integration test connecting to real Chrome instance</requirement>
        <requirement>Test connection failure scenarios</requirement>
        <requirement>Test resource cleanup with try-with-resources</requirement>
        <requirement>Test concurrent access from multiple threads</requirement>
    </testing-requirements>

    <estimated-effort>8-10 hours</estimated-effort>
</task>
