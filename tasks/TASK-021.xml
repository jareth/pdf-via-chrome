<?xml version="1.0" encoding="UTF-8"?>
<task>
    <task-id>TASK-021</task-id>
    <task-name>Create Integration Tests with Testcontainers (HTML-to-PDF)</task-name>
    <phase>Phase 3: API Design with Builder Pattern</phase>
    <priority>HIGH</priority>
    <complexity>COMPLEX</complexity>
    <status>Completed</status>

    <dependencies>
        <dependency>TASK-018: Create HTML-to-PDF Converter</dependency>
    </dependencies>

    <description>
        Create integration test suite using Testcontainers with Chrome Docker image.
        These tests validate end-to-end HTML-to-PDF generation with real Chrome instances
        in isolated containers. URL-to-PDF tests are deferred to Version 2 (Phase 8).
    </description>

    <acceptance-criteria>
        <criterion>Integration tests using Testcontainers</criterion>
        <criterion>Uses selenium/standalone-chrome Docker image</criterion>
        <criterion>Tests HTML to PDF conversion end-to-end</criterion>
        <criterion>Validates generated PDF content</criterion>
        <criterion>Tests run with 'mvn verify' (failsafe plugin)</criterion>
        <criterion>Docker available check (skip tests if Docker unavailable)</criterion>
    </acceptance-criteria>

    <implementation-notes>
        <note>
            Use @Testcontainers and @Container annotations
        </note>
        <note>
            Container configuration:
            GenericContainer chrome = new GenericContainer("selenium/standalone-chrome:latest")
                .withExposedPorts(9222)
                .withCommand("--remote-debugging-port=9222");
        </note>
        <note>
            Get Chrome DevTools endpoint from container
        </note>
        <note>
            Test scenarios:
            - Simple HTML to PDF
            - HTML with CSS to PDF
            - HTML with images to PDF
            - Various PdfOptions (landscape, margins, etc.)
            - Custom page sizes and margins
        </note>
        <note>
            Validate PDF: Check file signature (%PDF-1.4) and size &gt; 0
        </note>
        <note>
            Optional: Use Apache PDFBox to parse and validate PDF content
        </note>
        <note>
            Tests class name: *IT.java (for failsafe plugin)
        </note>
    </implementation-notes>

    <affected-files>
        <file>pdf-via-chrome/src/test/java/com/fostermoore/pdfviachrome/PdfGenerationIT.java</file>
        <file>pdf-via-chrome/src/test/java/com/fostermoore/pdfviachrome/HtmlToPdfIT.java</file>
        <file>pdf-via-chrome/pom.xml (add Testcontainers dependency)</file>
    </affected-files>
    <note>UrlToPdfIT.java moved to Version 2 (Phase 8, TASK-043)</note>

    <testing-requirements>
        <requirement>Tests run with 'mvn verify'</requirement>
        <requirement>Tests skip gracefully if Docker unavailable</requirement>
        <requirement>All integration tests pass</requirement>
        <requirement>Generated PDFs are valid</requirement>
        <requirement>Tests clean up containers after execution</requirement>
    </testing-requirements>

    <estimated-effort>8-10 hours</estimated-effort>
</task>
